---
title: "DATA608 Final Project"
author: "LeTicia Cancel"
date: "5/20/2022"
output: 
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r warning=FALSE, error=FALSE, message=FALSE}
library(dplyr)
library(ggplot2)
library(shiny)
library(plotly)
library(stringr)
require(maps)
require(gridExtra)
library(tidyr)
```

# Food Insecurity in America

Food insecurity as defined by the U.S. Department of Agriculture is the "household-level economic and social condition of limited or uncertain access to adequate food". [1] We will explore the distribution of individuals and families who use programs to assist with food. We will also explore survey results to see in relative real time how families about their food situation now. 

# Datasets
```{r}
snap_person <- read.csv("https://raw.githubusercontent.com/ltcancel/DATA608/main/Final%20Project/SNAP%20Person%20Count%2005032022_cleaned.csv")
snap_hh <- read.csv("https://raw.githubusercontent.com/ltcancel/DATA608/main/Final%20Project/SNAP%20Household%20Count%2005032022_cleaned.csv")
survey_df <- read.csv("https://raw.githubusercontent.com/ltcancel/DATA608/main/Final%20Project/Food%20Security%20Survey.csv")
```
Three datasets were used  for this analysis. The first is a count of individuals participating in Supplemental Nutrition Assistance Program (SNAP) in February 2022. The data is as of May 3, 2022. [2]
```{r}
head(snap_person)
```

The second dataset is the same as the dataset above but for households. 
```{r}
head(snap_hh)
```

The third dataset contains Food Sufficiency survey results from March 30, 2022 - April 11, 2022 from individual over the age of 18 in each state. Possible survey responses were: [3]
1 - Enough of the kinds of food wanted
2 - Enough food, but not always the kinds wanted
3 - Sometimes not enough to eat
4 - Often not enough to eat
5 - Did not report
```{r}
head(survey_df)
```


```{r fig.height=30, fig.width=30, warning=FALSE}
# clean the February column of both dataframes toreplace '--' with NA and convert to an integer
snap_hh$February <- as.integer(gsub(",","",snap_hh$February))
snap_person$February <- as.integer(gsub(",","",snap_person$February))
snap_hh$State <- tolower(snap_hh$State)
snap_person$State <- tolower(snap_person$State)
survey_df <- select(survey_df, -c(US1, US2, US3, US4, US5))
```

```{r}
#combine map data from the Maps library which includes longitude and latitude data
states_map <- map_data("state")
snap_hh_map <- merge(snap_hh, states_map, by.x = c("State"), by.y = c("region"))
snap_person_map <- merge(snap_person, states_map, by.x = c("State"), by.y = c("region"))
head(snap_hh)
```

```{r}
#combine map data from the Maps library which includes longitude and latitude data
states_map <- map_data("state")
snap_hh_map <- merge(snap_hh, states_map, by.x = c("State"), by.y = c("region"))
snap_person_map <- merge(snap_person, states_map, by.x = c("State"), by.y = c("region"))

plot_hh1 <- ggplot(snap_hh_map, aes(long, lat, group = group)) +
  geom_polygon(aes(fill = February), color = "white") +
  scale_fill_viridis_c(option = "C")

plot_hh2 <- ggplot(snap_hh, aes(x = reorder(State, February), y = February, fill = State)) +
  geom_bar(stat = "identity") +
  labs(x = "State", y = "Household Count", title = "Supplemental Nutrition Assistance Program: Number of Households Participating") +
  coord_flip() +
  theme(legend.position = "none")
```


```{r fig.height=7, fig.width=20, warning=FALSE}
grid.arrange(plot_hh1, plot_hh2, ncol=2)
```


```{r fig.height=7, fig.width=20, warning=FALSE}
plot_person1 <- ggplot(snap_person_map, aes(long, lat, group = group)) +
  geom_polygon(aes(fill = February), color = "white") +
  scale_fill_viridis_c(option = "C")

plot_person2 <- ggplot(snap_person, aes(x = reorder(State, February), y = February, fill = State)) +
  geom_bar(stat = "identity") +
  labs(x = "State", y = "Person Count", title = "Supplemental Nutrition Assistance Program: Number of Persons Participating") +
  coord_flip() +
  theme(legend.position = "none")

grid.arrange(plot_person1, plot_person2, ncol=2)
```

Questions
1) Enough of the kinds of food wanted
2) Enough food, but not always the kinds wanted
3) Sometimes not enough to eat
4) Often not enough to eat
5) Did not report


```{r}
transformed_df <- survey_df %>%
  gather(key = "response", value = "count", AL1:METRO5)

transformed_df$State <- substr(transformed_df$response, 1,2)
transformed_df$response <- substr(transformed_df$response, 3, 3)

transformed_df <- transformed_df %>%
  mutate(response = ifelse(response =="1", "Enough of the kinds of food wanted", ifelse(response=="2", "Enough food, but not always the kinds wanted", ifelse(response=="3", "Sometimes not enough to eat", ifelse(response=="4", "Often not enough to eat", ifelse(response=="5","Did not report",NA))))))

head(transformed_df)
```



```{r warning=FALSE, fig.height=20, fig.width=20}
p_age <- transformed_df %>%
  filter(Question == "Age") %>%
  ggplot(aes(fill = response, x = State, y = count)) +
  geom_bar(position = "stack", stat = "identity") +
  facet_wrap(~Characteristics, ncol = 2) +
  theme(legend.position = "none", axis.text.x = element_text(angle = 90))

p_gender <- transformed_df %>%
  filter(Question == "Gender") %>%
  ggplot(aes(fill = response, x = State, y = count)) +   
  geom_bar(position = "stack", stat = "identity") +
  facet_wrap(~Characteristics, ncol = 2) +
  theme(legend.position = "none", axis.text.x = element_text(angle = 90))

p_edu <- transformed_df %>%
  filter(Question == "Education") %>%
  ggplot(aes(fill = response, x = State, y = count)) +   
  geom_bar(position = "stack", stat = "identity") +
  facet_wrap(~Characteristics, ncol = 2) +
  theme(legend.position = "bottom", axis.text.x = element_text(angle = 90))

grid.arrange(p_age, p_gender, p_edu, ncol = 1)
```

```{r}
ui <- fluidPage(
  
  headerPanel("Food Sufficiency for Households: March 30-April 11"),
  
  sidebarPanel(
   selectInput('cause','Survey Question', unique(transformed_df$Question)) 
  ),
  
  fluidRow(
    column(10,plotOutput("plot1"))
    #column(6,tableOutput("table1"))    
  )

  
  #fluidRow(
   # mainPanel(plotOutput("plot1", width = "100%"), tableOutput("table1"))
  #)
  
  
  
  
)
server <- function(input,output){
  
  output$plot1 <- renderPlot({
      
  filterdf <- transformed_df %>% 
    filter(Question == input$cause)
  
  ggplot(filterdf, aes(fill = response, x = State, y = count)) +  
    geom_bar(position = "stack", stat = "identity") +
    facet_wrap(~Characteristics, ncol = 1) +
    theme(legend.position = "top", axis.text = element_text(size = 14), axis.text.x = element_text(angle = 90), axis.title = element_text(size = 14), text = element_text(size = 14)) + 
    labs(y = "Household Count", fill = "Survey Response")
  
  }, height = 900, width = 1200)

  output$table1 <- renderTable({
    filterdf <- transformed_df %>%
      filter(Question == input$cause)
    
    filterdf %>%
      na.omit() %>%
      group_by(State, response) %>%
      summarise(count = sum(count)) %>%
      spread(State, count)
      
  })
  
}

shinyApp(ui, server)
```

# Resources
1 - https://www.ers.usda.gov/topics/food-nutrition-assistance/food-security-in-the-u-s/definitions-of-food-security/
2 - Number of persons and households participating in Supplemental Nutrition Assistance program (SNAP) as of May 3, 2022 https://www.fns.usda.gov/pd/supplemental-nutrition-assistance-program-snap 
3 - Week 44 Household Pulse Survey: March 30-April 11 https://www.census.gov/data/tables/2022/demo/hhp/hhp44.html 



